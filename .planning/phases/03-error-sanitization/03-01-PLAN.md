---
phase: 03-error-sanitization
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/workshop_mcp/logging_context.py
  - tests/test_logging_context.py
autonomous: true

must_haves:
  truths:
    - "Correlation ID is generated for each request context"
    - "Correlation ID appears in log records within request context"
    - "Correlation ID defaults to '-' outside request context"
    - "Context manager properly resets correlation ID after request"
  artifacts:
    - path: "src/workshop_mcp/logging_context.py"
      provides: "Correlation ID context management"
      exports: ["correlation_id_var", "CorrelationIdFilter", "request_context"]
      min_lines: 40
    - path: "tests/test_logging_context.py"
      provides: "Test coverage for logging context"
      min_lines: 60
  key_links:
    - from: "src/workshop_mcp/logging_context.py"
      to: "contextvars"
      via: "import ContextVar"
      pattern: "import contextvars|from contextvars import"
    - from: "src/workshop_mcp/logging_context.py"
      to: "logging"
      via: "Filter subclass"
      pattern: "class.*Filter.*logging\\.Filter"
---

<objective>
Create the logging context module using TDD to provide correlation ID management for request tracing.

Purpose: Enable request-scoped correlation IDs that inject into all log records within a request context, supporting ERR-02 (log full error details internally with correlation IDs for debugging).

Output: Working logging_context.py module with ContextVar, Filter, and context manager, tested via TDD cycle.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-error-sanitization/03-RESEARCH.md
</context>

<feature>
  <name>Logging Context Module</name>
  <files>
    src/workshop_mcp/logging_context.py
    tests/test_logging_context.py
  </files>
  <behavior>
    ContextVar management:
    - correlation_id_var.get() -> "-" (default when not in request context)
    - Within request_context(): correlation_id_var.get() -> 8-char hex ID
    - After request_context() exits: correlation_id_var.get() -> "-" (reset to default)

    Logging filter:
    - CorrelationIdFilter adds correlation_id attribute to log records
    - Log record outside context: record.correlation_id == "-"
    - Log record inside context: record.correlation_id == current request ID

    Context manager:
    - request_context() yields 8-char hex correlation ID
    - ID is uuid4().hex[:8] (first 8 chars of hex UUID)
    - Context properly resets on normal exit
    - Context properly resets on exception

    Integration pattern:
    - with request_context() as corr_id:
          logger.info("message")  # Log includes correlation_id
          # corr_id available for including in error responses
  </behavior>
  <implementation>
    1. Create src/workshop_mcp/logging_context.py with:
       - correlation_id_var: ContextVar[str] with default "-"
       - CorrelationIdFilter(logging.Filter) that sets record.correlation_id
       - request_context() context manager using uuid4().hex[:8]
    2. Use token = correlation_id_var.set(id) and correlation_id_var.reset(token) pattern
    3. Context manager must handle exceptions (use try/finally)
    4. No external dependencies - stdlib only (contextvars, logging, uuid, contextlib)
  </implementation>
</feature>

<verification>
```bash
# All logging context tests pass
poetry run pytest tests/test_logging_context.py -v

# Type checking passes
poetry run mypy src/workshop_mcp/logging_context.py

# All existing tests still pass
poetry run pytest --tb=short
```
</verification>

<success_criteria>
1. correlation_id_var exists as ContextVar with default "-"
2. CorrelationIdFilter adds correlation_id attribute to log records
3. request_context() generates 8-char hex IDs
4. request_context() properly resets ContextVar on exit
5. request_context() properly resets ContextVar on exception
6. All test assertions pass via TDD cycle
</success_criteria>

<output>
After completion, create `.planning/phases/03-error-sanitization/03-01-SUMMARY.md`
</output>
