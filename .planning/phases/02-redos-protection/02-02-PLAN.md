---
phase: 02-redos-protection
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - pyproject.toml
  - src/workshop_mcp/keyword_search.py
  - tests/test_keyword_search.py
autonomous: true

must_haves:
  truths:
    - "Regex operations timeout after 1 second per file"
    - "Timed-out files are skipped and search continues"
    - "If >50% files timeout, search aborts"
    - "Skipped files appear in response metadata"
    - "Pattern validation runs before any file search"
  artifacts:
    - path: "src/workshop_mcp/keyword_search.py"
      provides: "ReDoS-protected keyword search"
      contains: ["import regex", "timeout=1.0", "skipped_files", "RegexAbortError"]
    - path: "pyproject.toml"
      provides: "regex library dependency"
      contains: "regex"
    - path: "tests/test_keyword_search.py"
      provides: "Integration tests for ReDoS protection"
  key_links:
    - from: "src/workshop_mcp/keyword_search.py"
      to: "src/workshop_mcp/security/regex_validator.py"
      via: "import validate_pattern"
      pattern: "from.*security.*import.*validate_pattern"
    - from: "src/workshop_mcp/keyword_search.py"
      to: "regex library"
      via: "findall with timeout"
      pattern: "pattern\\.findall.*timeout"
---

<objective>
Integrate the regex library and RegexValidator into keyword_search.py for ReDoS protection.

Purpose: Make the keyword_search tool resilient to denial-of-service attacks by adding timeouts to regex operations and integrating pattern validation from Plan 01.

Output: keyword_search.py using `regex` library with per-file timeouts, abort threshold, and skipped file tracking.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-redos-protection/02-RESEARCH.md
@.planning/phases/02-redos-protection/02-01-SUMMARY.md
@src/workshop_mcp/keyword_search.py
@src/workshop_mcp/security/regex_validator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add regex library dependency</name>
  <files>pyproject.toml</files>
  <action>
    Add the `regex` library as a dependency using poetry:
    ```bash
    poetry add regex
    ```
    This is a drop-in replacement for Python's `re` module with native timeout support.
  </action>
  <verify>
    ```bash
    poetry show regex
    grep -q 'regex' pyproject.toml && echo "regex dependency found"
    ```
  </verify>
  <done>regex library is installed and listed in pyproject.toml dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Integrate ReDoS protection into keyword_search.py</name>
  <files>src/workshop_mcp/keyword_search.py</files>
  <action>
    Modify keyword_search.py to add ReDoS protection:

    1. **Replace re with regex:**
       - Change `import re` to `import regex`
       - Change `from typing import ... Pattern` to use `regex.Pattern` or just remove Pattern type hint (regex lib handles it)
       - Update all `re.compile()` to `regex.compile()`
       - Update all `re.findall()` to `regex.findall()`
       - Update `re.error` to `regex.error`
       - Update `re.IGNORECASE` to `regex.IGNORECASE`
       - Update `re.escape()` to `regex.escape()`

    2. **Add pattern validation at start of execute():**
       ```python
       from workshop_mcp.security import validate_pattern, RegexValidationError, RegexAbortError

       # In execute(), after input validation:
       validate_pattern(keyword, use_regex)
       ```

    3. **Add timeout to _count_occurrences():**
       - When pattern is not None: `pattern.findall(content, timeout=1.0)`
       - When using case_insensitive plain search: `regex.findall(regex.escape(keyword), content, regex.IGNORECASE, timeout=1.0)`
       - Wrap in try/except TimeoutError

    4. **Track skipped files in _search_file():**
       - Add skipped_files tracking to result dict
       - On TimeoutError: add file to skipped_files, continue search
       - Pass timeout count back to execute method for abort check

    5. **Implement abort threshold in execute():**
       - After all searches complete, check if >50% files skipped due to timeout
       - If so, raise RegexAbortError("Pattern timed out on too many files")

    6. **Update result structure:**
       - Add `metadata` dict with `skipped_files` list and `skip_reason` field
       - Only include metadata if there are skipped files

    Key implementation notes:
    - Timeout is per-file (1 second), not per-operation
    - The TimeoutError from regex library is the standard TimeoutError, not a custom exception
    - Keep existing _build_pattern() ReDoS checks as defense-in-depth (they provide earlier rejection before timeout is needed)
    - Log skipped files at WARNING level for debugging
  </action>
  <verify>
    ```bash
    # Check imports changed
    grep -q "import regex" src/workshop_mcp/keyword_search.py && echo "regex import found"

    # Check timeout added
    grep -q "timeout=1.0" src/workshop_mcp/keyword_search.py && echo "timeout found"

    # Check pattern validation
    grep -q "validate_pattern" src/workshop_mcp/keyword_search.py && echo "validate_pattern found"

    # Syntax check
    python -c "from workshop_mcp.keyword_search import KeywordSearchTool; print('Import OK')"
    ```
  </verify>
  <done>keyword_search.py uses regex library with 1-second timeout, calls validate_pattern(), tracks skipped files, implements >50% abort threshold</done>
</task>

<task type="auto">
  <name>Task 3: Add integration tests for ReDoS protection</name>
  <files>tests/test_keyword_search.py</files>
  <action>
    Add new test class TestReDoSProtection to test_keyword_search.py:

    1. **Test pattern validation integration:**
       - test_rejects_pattern_exceeding_length_limit: 501-char pattern raises RegexValidationError
       - test_rejects_redos_pattern: "(a+)+" raises RegexValidationError
       - test_accepts_valid_regex: "[a-z]+" works normally

    2. **Test timeout behavior:**
       - test_timeout_skips_file_continues_search: Create scenario where one file would timeout (use mock)
       - test_timeout_reported_in_metadata: Verify skipped_files appears in result

    3. **Test abort threshold:**
       - test_abort_when_majority_timeout: When >50% files timeout, raises RegexAbortError

    Implementation approach for timeout tests:
    - Mock the regex library's findall to raise TimeoutError for specific files
    - Or use a real ReDoS pattern on crafted content (risky - may hang test)
    - Recommended: Use mocking to simulate timeout behavior deterministically

    Example test structure:
    ```python
    @pytest.mark.asyncio
    async def test_timeout_skips_file_continues_search(tmp_path, monkeypatch):
        # Create test files
        (tmp_path / "file1.py").write_text("hello world")
        (tmp_path / "file2.py").write_text("hello again")

        # Mock to timeout on first file only
        original_findall = regex.Pattern.findall
        call_count = [0]
        def mock_findall(self, string, *args, **kwargs):
            call_count[0] += 1
            if call_count[0] == 1:
                raise TimeoutError("timeout")
            return original_findall(self, string, *args, **kwargs)

        monkeypatch.setattr(regex.Pattern, "findall", mock_findall)

        tool = KeywordSearchTool()
        result = await tool.execute("hello", [str(tmp_path)], use_regex=True)

        assert "metadata" in result
        assert len(result["metadata"]["skipped_files"]) == 1
        assert result["summary"]["total_files_with_matches"] >= 1
    ```
  </action>
  <verify>
    ```bash
    # Run new ReDoS tests
    poetry run pytest tests/test_keyword_search.py -v -k "redos or timeout or abort"

    # All keyword search tests pass
    poetry run pytest tests/test_keyword_search.py -v

    # All tests pass
    poetry run pytest --tb=short
    ```
  </verify>
  <done>Integration tests verify pattern validation, timeout handling, skipped file tracking, and abort threshold</done>
</task>

</tasks>

<verification>
```bash
# regex library installed
poetry show regex

# All imports work
python -c "from workshop_mcp.keyword_search import KeywordSearchTool; print('OK')"
python -c "from workshop_mcp.security import validate_pattern, RegexValidationError, RegexAbortError; print('OK')"

# All tests pass
poetry run pytest --tb=short

# Type checking (informational - pre-existing errors OK)
poetry run mypy src/workshop_mcp/keyword_search.py || true
```
</verification>

<success_criteria>
1. regex library is a project dependency
2. keyword_search.py uses `import regex` instead of `import re`
3. All findall operations have timeout=1.0
4. validate_pattern() called before search begins
5. Skipped files tracked in result metadata
6. >50% timeout triggers RegexAbortError
7. All existing keyword_search tests pass
8. New ReDoS protection tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-redos-protection/02-02-SUMMARY.md`
</output>
