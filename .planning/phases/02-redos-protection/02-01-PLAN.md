---
phase: 02-redos-protection
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/workshop_mcp/security/exceptions.py
  - src/workshop_mcp/security/regex_validator.py
  - src/workshop_mcp/security/__init__.py
  - tests/test_regex_validator.py
autonomous: true

must_haves:
  truths:
    - "Patterns longer than 500 characters are rejected"
    - "Known ReDoS patterns (nested quantifiers) are rejected"
    - "Invalid regex syntax is rejected with generic message"
    - "Valid patterns pass validation"
  artifacts:
    - path: "src/workshop_mcp/security/regex_validator.py"
      provides: "Pattern validation logic"
      exports: ["validate_pattern", "MAX_PATTERN_LENGTH"]
      min_lines: 40
    - path: "src/workshop_mcp/security/exceptions.py"
      provides: "Regex security exceptions"
      contains: ["RegexValidationError", "RegexTimeoutError", "RegexAbortError"]
    - path: "tests/test_regex_validator.py"
      provides: "Test coverage for regex validation"
      min_lines: 100
  key_links:
    - from: "src/workshop_mcp/security/regex_validator.py"
      to: "src/workshop_mcp/security/exceptions.py"
      via: "import RegexValidationError"
      pattern: "from.*exceptions.*import.*RegexValidationError"
    - from: "src/workshop_mcp/security/__init__.py"
      to: "src/workshop_mcp/security/regex_validator.py"
      via: "public exports"
      pattern: "from.*regex_validator.*import"
---

<objective>
Create the RegexValidator security module using TDD to validate regex patterns before execution.

Purpose: Provide the foundation for ReDoS protection by validating pattern length, detecting known ReDoS patterns, and validating syntax - all before any regex operation runs.

Output: Working regex_validator.py module with exceptions, tested via TDD cycle.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-redos-protection/02-RESEARCH.md
@src/workshop_mcp/security/exceptions.py
@src/workshop_mcp/security/__init__.py
</context>

<feature>
  <name>RegexValidator Module</name>
  <files>
    src/workshop_mcp/security/regex_validator.py
    src/workshop_mcp/security/exceptions.py
    src/workshop_mcp/security/__init__.py
    tests/test_regex_validator.py
  </files>
  <behavior>
    Pattern length validation:
    - validate_pattern("a" * 501, use_regex=True) -> raises RegexValidationError("Pattern exceeds maximum length (500 characters)")
    - validate_pattern("a" * 500, use_regex=True) -> passes (at limit)
    - validate_pattern("simple", use_regex=False) -> passes (non-regex always passes length check)

    ReDoS pattern detection:
    - validate_pattern("(a+)+", use_regex=True) -> raises RegexValidationError("Pattern rejected: nested quantifiers detected")
    - validate_pattern("(.*)+", use_regex=True) -> raises RegexValidationError("Pattern rejected: nested quantifiers detected")
    - validate_pattern("(.+)*", use_regex=True) -> raises RegexValidationError("Pattern rejected: nested quantifiers detected")
    - validate_pattern("(?:a+)+", use_regex=True) -> raises RegexValidationError("Pattern rejected: nested quantifiers detected")
    - validate_pattern("a+b+", use_regex=True) -> passes (sequential quantifiers are safe)
    - validate_pattern(".*", use_regex=True) -> passes (simple quantifiers are safe)

    Syntax validation:
    - validate_pattern("[invalid", use_regex=True) -> raises RegexValidationError("Invalid regex syntax")
    - validate_pattern("(unclosed", use_regex=True) -> raises RegexValidationError("Invalid regex syntax")
    - validate_pattern("[a-z]+", use_regex=True) -> passes (valid syntax)

    Non-regex mode:
    - validate_pattern("any string", use_regex=False) -> passes (no regex validation)
    - validate_pattern("(a+)+", use_regex=False) -> passes (treated as literal)

    Exception hierarchy:
    - RegexValidationError inherits from SecurityValidationError
    - RegexTimeoutError inherits from SecurityValidationError (default msg: "Pattern evaluation timed out")
    - RegexAbortError inherits from SecurityValidationError (default msg: "Pattern timed out on too many files")
  </behavior>
  <implementation>
    1. Add RegexValidationError, RegexTimeoutError, RegexAbortError to exceptions.py
    2. Create regex_validator.py with:
       - MAX_PATTERN_LENGTH = 500
       - REDOS_PATTERNS list (minimal blocklist from research)
       - _is_redos_pattern(pattern: str) -> bool
       - validate_pattern(pattern: str, use_regex: bool) -> None (raises on failure)
    3. Update __init__.py to export new exceptions and validate_pattern
    4. Use standard `re` module for blocklist checking (not the regex library)
  </implementation>
</feature>

<verification>
```bash
# All regex validator tests pass
poetry run pytest tests/test_regex_validator.py -v

# Type checking passes
poetry run mypy src/workshop_mcp/security/

# All existing tests still pass
poetry run pytest --tb=short
```
</verification>

<success_criteria>
1. RegexValidationError, RegexTimeoutError, RegexAbortError exist and inherit from SecurityValidationError
2. validate_pattern() rejects patterns > 500 chars
3. validate_pattern() rejects known ReDoS patterns (nested quantifiers)
4. validate_pattern() rejects invalid regex syntax
5. validate_pattern() passes valid patterns
6. Non-regex mode bypasses all regex-specific validation
7. All test assertions pass via TDD cycle
</success_criteria>

<output>
After completion, create `.planning/phases/02-redos-protection/02-01-SUMMARY.md`
</output>
