---
phase: 04-security-exception-handler
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/workshop_mcp/server.py
  - tests/test_security_exception_handler.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "RegexValidationError returns -32602 with 'Pattern rejected: nested quantifiers detected'"
    - "RegexAbortError returns -32602 with 'Pattern timed out on too many files'"
    - "SecurityValidationError handler executes before generic Exception handler"
    - "PathValidationError continues to work correctly (no regression)"
  artifacts:
    - path: "src/workshop_mcp/server.py"
      provides: "SecurityValidationError handler in tool execution"
      contains: ["SecurityValidationError", "logger.warning"]
    - path: "tests/test_security_exception_handler.py"
      provides: "Integration tests for security exception passthrough"
      min_lines: 80
  key_links:
    - from: "src/workshop_mcp/server.py"
      to: "src/workshop_mcp/security/__init__.py"
      via: "import SecurityValidationError"
      pattern: "from.*security.*import.*SecurityValidationError"
---

<objective>
Fix cross-phase integration gap where SecurityValidationError subclasses (RegexValidationError, RegexAbortError) are caught by the generic Exception handler instead of passing through their safe messages.

Purpose: Close the gap identified in v1-MILESTONE-AUDIT.md where ReDoS protection errors return "Internal error" instead of their designed safe messages like "Pattern rejected: nested quantifiers detected".

Output: server.py with SecurityValidationError handler before generic Exception handler, and integration tests proving correct error messages reach clients.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/workshop_mcp/server.py
@src/workshop_mcp/security/exceptions.py
@src/workshop_mcp/keyword_search.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SecurityValidationError integration tests</name>
  <files>tests/test_security_exception_handler.py</files>
  <action>
    Create tests that verify SecurityValidationError subclasses pass through their safe messages.

    Test cases:
    1. **RegexValidationError passthrough** - Verify nested quantifier rejection message
       - Mock keyword_search_tool.execute to raise RegexValidationError("Pattern rejected: nested quantifiers detected")
       - Assert response code is -32602 (Invalid params)
       - Assert error message is "Pattern rejected: nested quantifiers detected"
       - Assert no "Internal error" is returned

    2. **RegexAbortError passthrough** - Verify timeout abort message
       - Mock keyword_search_tool.execute to raise RegexAbortError("Pattern timed out on too many files")
       - Assert response code is -32602 (Invalid params)
       - Assert error message is "Pattern timed out on too many files"
       - Assert no "Internal error" is returned

    3. **RegexTimeoutError passthrough** - Verify single-file timeout message
       - Mock keyword_search_tool.execute to raise RegexTimeoutError("Pattern evaluation timed out")
       - Assert response code is -32602 (Invalid params)
       - Assert error message is "Pattern evaluation timed out"

    4. **SecurityValidationError base class** - Verify base class also passes through
       - Mock to raise SecurityValidationError("Generic security error")
       - Assert message passes through

    5. **PathValidationError regression test** - Verify existing behavior unchanged
       - Use path outside allowed roots (e.g., /etc/passwd)
       - Assert still returns "Path is outside allowed directories"
       - Assert code is -32602

    6. **Logging verification** - Verify warning logged with message
       - Use caplog fixture
       - Assert logger.warning called with security exception message

    Testing approach:
    - Use WorkshopMCPServer._handle_request() with mocked tool execution
    - Set MCP_ALLOWED_ROOTS via monkeypatch for valid path validation
    - Follow existing test patterns from test_error_sanitization.py
  </action>
  <verify>Tests exist and FAIL because SecurityValidationError handler is missing</verify>
  <done>Test file with 6 test cases verifying SecurityValidationError passthrough</done>
</task>

<task type="auto">
  <name>Task 2: Add SecurityValidationError handler to server.py</name>
  <files>src/workshop_mcp/server.py</files>
  <action>
    Add SecurityValidationError handler in both tool execution methods to catch security exceptions before the generic Exception handler.

    **Change 1: Update imports (line 19)**
    Add SecurityValidationError to the import from .security:
    ```python
    from .security import PathValidator, PathValidationError, SecurityValidationError
    ```

    **Change 2: Add handler in _execute_keyword_search (before line 440)**
    Insert BEFORE `except Exception as exc:`:
    ```python
    except SecurityValidationError as exc:
        logger.warning("Security validation error: %s", exc)
        return self._error_response(
            request_id,
            JsonRpcError(-32602, str(exc)),
        )
    ```

    **Change 3: Add handler in _execute_performance_check (before line 565)**
    Insert BEFORE `except Exception as exc:`:
    ```python
    except SecurityValidationError as exc:
        logger.warning("Security validation error: %s", exc)
        return self._error_response(
            request_id,
            JsonRpcError(-32602, str(exc)),
        )
    ```

    Order matters: SecurityValidationError must be caught BEFORE Exception.

    Note: This catches all SecurityValidationError subclasses:
    - PathValidationError (already handled separately, but harmless to double-cover)
    - RegexValidationError (main target)
    - RegexAbortError (main target)
    - RegexTimeoutError (main target)

    All these exceptions have safe messages by design (see exceptions.py).
  </action>
  <verify>
    # Tests should now PASS
    poetry run pytest tests/test_security_exception_handler.py -v
  </verify>
  <done>SecurityValidationError handler added before generic Exception in both tool execution methods</done>
</task>

<task type="auto">
  <name>Task 3: Run full test suite and verify no regressions</name>
  <files>none</files>
  <action>
    Verify the fix works correctly and doesn't break existing functionality.

    Run checks:
    1. New tests pass: `poetry run pytest tests/test_security_exception_handler.py -v`
    2. Existing error sanitization tests pass: `poetry run pytest tests/test_error_sanitization.py -v`
    3. Full test suite passes: `poetry run pytest --tb=short`
    4. Type checking passes: `poetry run mypy src/workshop_mcp/server.py`

    If any tests fail, investigate and fix before marking complete.
  </action>
  <verify>
    poetry run pytest --tb=short
    poetry run mypy src/workshop_mcp/server.py
  </verify>
  <done>All tests pass including new SecurityValidationError tests, type checking passes</done>
</task>

</tasks>

<verification>
```bash
# New integration tests pass
poetry run pytest tests/test_security_exception_handler.py -v

# Existing tests still pass (no regressions)
poetry run pytest tests/test_error_sanitization.py -v
poetry run pytest --tb=short

# Type checking passes
poetry run mypy src/workshop_mcp/server.py

# Verify import works
python -c "from workshop_mcp.security import SecurityValidationError; print('Import OK')"
```
</verification>

<success_criteria>
1. RegexValidationError returns -32602 with safe message (not "Internal error")
2. RegexAbortError returns -32602 with safe message (not "Internal error")
3. RegexTimeoutError returns -32602 with safe message (not "Internal error")
4. PathValidationError still works correctly (no regression)
5. Security exceptions are logged at WARNING level
6. All existing tests pass (no regressions)
7. Type checking passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-security-exception-handler/04-01-SUMMARY.md`
</output>
